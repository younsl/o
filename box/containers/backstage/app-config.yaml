# ==============================================================================
# Backstage Configuration
# ==============================================================================
# This configuration file sets up Backstage with GitLab integration
# for auto-discovery of catalog entities (components, APIs, etc.)
#
# Environment variables required:
#   - GITLAB_TOKEN: GitLab personal access token with api scope
#   - GITLAB_HOST: GitLab host (e.g., gitlab.com or self-hosted GitLab URL)
# ==============================================================================

app:
  title: Backstage
  baseUrl: http://localhost:3000
  # Frontend-accessible GitLab configuration
  gitlab:
    host: ${GITLAB_HOST}

organization:
  name: DevOps Portal

backend:
  baseUrl: http://localhost:7007
  listen:
    port: 7007
  csp:
    connect-src: ["'self'", 'http:', 'https:']
  cors:
    origin: http://localhost:3000
    methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
    credentials: true
  database:
    client: better-sqlite3
    connection: ':memory:'
  auth:
    dangerouslyDisableDefaultAuthPolicy: true

# ------------------------------------------------------------------------------
# GitLab Integration
# ------------------------------------------------------------------------------
integrations:
  gitlab:
    - host: ${GITLAB_HOST}
      token: ${GITLAB_TOKEN}
      apiBaseUrl: https://${GITLAB_HOST}/api/v4

# ------------------------------------------------------------------------------
# Catalog Configuration with GitLab Auto Discovery
# ------------------------------------------------------------------------------
catalog:
  # Import rules for discovered entities
  import:
    entityFilename: catalog-info.yaml
    pullRequestBranchName: backstage-integration

  rules:
    - allow: [Component, System, API, Resource, Location, Domain, Group, User, Template]

  # GitLab discovery providers
  providers:
    # Discovers catalog-info.yaml files from GitLab repositories
    gitlab:
      yourProviderId:
        host: ${GITLAB_HOST}
        # Discover from specific group (optional)
        # group: my-group
        # Branch to scan (default: main)
        branch: main
        # Fallback branch if main doesn't exist
        fallbackBranch: master
        # Skip projects that are forks
        skipForkedRepos: false
        # Entity filename to discover
        entityFilename: catalog-info.yaml
        # Schedule for periodic discovery
        schedule:
          frequency: { minutes: 1 }
          timeout: { minutes: 3 }
          initialDelay: { seconds: 10 }

    # Discovers GitLab groups and users as org entities
    gitlabOrg:
      yourOrgProviderId:
        host: ${GITLAB_HOST}
        # Specific group ID to discover (optional - discovers all if not set)
        # id: 12345
        # Group pattern to match (optional)
        # groupPattern: ^my-org-.*
        schedule:
          frequency: { hours: 1 }
          timeout: { minutes: 5 }
          initialDelay: { seconds: 30 }

  # Static locations (optional - for manual entity registration)
  locations:
    - type: file
      target: ../../templates/register-component/template.yaml
      rules:
        - allow: [Template]

# ------------------------------------------------------------------------------
# Auth Configuration
# ------------------------------------------------------------------------------
auth:
  environment: development
  # Session secret is required for OIDC authentication
  session:
    secret: ${AUTH_SESSION_SECRET}
  providers:
    # Keycloak OIDC authentication
    oidc:
      development:
        clientId: ${KEYCLOAK_CLIENT_ID}
        clientSecret: ${KEYCLOAK_CLIENT_SECRET}
        metadataUrl: ${KEYCLOAK_METADATA_URL}
        # Example: https://keycloak.example.com/realms/your-realm/.well-known/openid-configuration
        prompt: auto
        signIn:
          resolvers:
            # Allow sign-in even without matching User entity in catalog
            - resolver: emailLocalPartMatchingUserEntityName
              dangerouslyAllowSignInWithoutUserInCatalog: true

# ------------------------------------------------------------------------------
# Scaffolder Configuration
# ------------------------------------------------------------------------------
scaffolder:
  # Use hosts from integrations.gitlab as default allowedHosts for RepoUrlPicker
  defaultScmIntegrations: true

# ------------------------------------------------------------------------------
# TechDocs Configuration
# ------------------------------------------------------------------------------
techdocs:
  builder: 'local'
  generator:
    runIn: 'local'
  publisher:
    type: 'local'

# ------------------------------------------------------------------------------
# Proxy Configuration (optional)
# ------------------------------------------------------------------------------
proxy:
  endpoints: {}

# ------------------------------------------------------------------------------
# Search Configuration
# ------------------------------------------------------------------------------
search:
  collators:
    catalog:
      schedule:
        frequency: { minutes: 1 }
        timeout: { minutes: 15 }
        initialDelay: { seconds: 10 }
