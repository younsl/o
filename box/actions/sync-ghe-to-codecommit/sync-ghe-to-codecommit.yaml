name: Mirror GHE to AWS CodeCommit
run-name: ğŸª© Mirror GHE to AWS CodeCommit on ${{ github.ref_name }} branch

on:
  # ëª¨ë“  ë¸Œëœì¹˜ì— ëŒ€í•´ í‘¸ì‹œ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì›Œí¬í”Œë¡œìš°ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.
  push:
    branches:
      - '*'
  
  # `workflow_dispatch` ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜ë™ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  # GitHub UIë¥¼ í†µí•´ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ìˆ˜ë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
  # ì´ëŠ” íŠ¹ì • ì¡°ê±´ì´ë‚˜ ì‹œì ì— ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•˜ê³  ì‹¶ì„ ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.
  workflow_dispatch:

env:
  CODECOMMIT_HTTPS_URL: 'https://git-codecommit.ap-northeast-2.amazonaws.com/v1/repos/<ENTER_YOUR_CODECOMMIT_REPOSITORY_NAME>'
 
jobs:
  mirror:
    runs-on: [self-hosted, linux, build]
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Configure AWS credentials
        uses: actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Install awscli
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install
      
      - name: Check cli tools
        id: check_cli
        run: |
          echo "Check git cli version installed in Actions Runner ..."
          git --version
          
          echo "Check awscli version installed in Actions Runner ..."
          aws --version
          echo "success=false" >> $GITHUB_OUTPUT

      - name: Mirror push to AWS CodeCommit
        if: steps.check_cli.outputs.success == 'true'
        run: |
          echo "Mirror push from github enterprise to codecommit ..."
          git config --global --add safe.directory /github/workspace
          git config --global credential.'https://git-codecommit.ap-northeast-2.amazonaws.com'.helper '!aws codecommit credential-helper $@'
          git config --global credential.UseHttpPath true
          git remote add codecommit $CODECOMMIT_HTTPS_URL
          git push codecommit --mirror
