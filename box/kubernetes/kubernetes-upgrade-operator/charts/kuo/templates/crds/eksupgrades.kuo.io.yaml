{{- if .Values.crds.install }}
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: eksupgrades.kuo.io
  labels:
    {{- include "kuo.labels" . | nindent 4 }}
  {{- with .Values.crds.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  group: kuo.io
  names:
    kind: EKSUpgrade
    listKind: EKSUpgradeList
    plural: eksupgrades
    singular: eksupgrade
    shortNames:
      - eu
  scope: Cluster
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: EKSUpgrade is the Schema for the eksupgrades API. It defines an EKS cluster upgrade operation managed by the kuo operator.
          properties:
            spec:
              type: object
              description: EKSUpgradeSpec defines the desired state of an EKS cluster upgrade.
              required:
                - clusterName
                - targetVersion
                - region
              properties:
                clusterName:
                  type: string
                  description: Name of the EKS cluster to upgrade.
                targetVersion:
                  type: string
                  description: Target Kubernetes version (e.g., "1.34"). The operator plans sequential minor version upgrades if multiple steps are needed.
                region:
                  type: string
                  description: AWS region where the EKS cluster resides (e.g., "ap-northeast-2").
                assumeRoleArn:
                  type: string
                  description: IAM Role ARN to assume for cross-account access. Works with both IRSA and EKS Pod Identity as the base credential source.
                addonVersions:
                  type: object
                  description: Optional add-on version overrides. Keys are add-on names and values are target versions. If not specified, the operator resolves the default compatible version automatically.
                  additionalProperties:
                    type: string
                skipPdbCheck:
                  type: boolean
                  default: false
                  description: Skip PDB drain deadlock check before node group rolling updates. When false (default), the operator checks that all PDBs allow at least one disruption.
                dryRun:
                  type: boolean
                  default: false
                  description: Plan only, do not execute. The operator generates an upgrade plan and sets the phase to Completed without making any changes to the cluster.
                timeouts:
                  type: object
                  description: Timeout configuration for upgrade operations.
                  properties:
                    controlPlaneMinutes:
                      type: integer
                      default: 30
                      description: Control plane upgrade timeout in minutes. The operator fails the upgrade if the control plane update does not complete within this duration.
                    nodegroupMinutes:
                      type: integer
                      default: 60
                      description: Node group upgrade timeout in minutes. The operator fails the upgrade if a node group rolling update does not complete within this duration.
                notification:
                  type: object
                  description: Slack notification configuration for this upgrade.
                  properties:
                    onUpgrade:
                      type: boolean
                      default: false
                      description: Send Slack notifications for actual upgrades (dryRun false).
                    onDryRun:
                      type: boolean
                      default: false
                      description: Send Slack notifications for dry-run executions (dryRun true).
            status:
              type: object
              description: EKSUpgradeStatus defines the observed state of the upgrade.
              properties:
                phase:
                  type: string
                  description: "Current phase of the upgrade process. Progresses through: Pending → Planning → PreflightChecking → UpgradingControlPlane → UpgradingAddons → UpgradingNodeGroups → Completed or Failed."
                  enum:
                    - Pending
                    - Planning
                    - PreflightChecking
                    - UpgradingControlPlane
                    - UpgradingAddons
                    - UpgradingNodeGroups
                    - Completed
                    - Failed
                currentVersion:
                  type: string
                  description: Current Kubernetes version of the EKS cluster control plane as observed by the operator.
                phases:
                  type: object
                  description: Per-phase status details grouped by upgrade phase.
                  properties:
                    planning:
                      type: object
                      description: Planning phase details. Populated after the Planning phase completes.
                      properties:
                        upgradePath:
                          type: array
                          description: Planned sequential upgrade path from current to target version (e.g., ["1.32", "1.33", "1.34"]). Each entry represents one minor version step.
                          items:
                            type: string
                    preflight:
                      type: object
                      description: Preflight checking phase details. Populated after the PreflightChecking phase completes.
                      properties:
                        checks:
                          type: array
                          description: Results of preflight validation checks.
                          items:
                            type: object
                            description: Result of a single preflight check.
                            properties:
                              name:
                                type: string
                                description: Name of the preflight check (e.g., "EKS Deletion Protection", "PDB Drain Deadlock").
                              status:
                                type: string
                                description: "Result of the check: Pass, Fail, Skip, or Info."
                              message:
                                type: string
                                description: Human-readable summary of the check result.
                    controlPlane:
                      type: object
                      description: Control plane upgrade phase details. Tracks sequential minor version upgrades.
                      properties:
                        currentStep:
                          type: integer
                          description: Current step number (1-based) in the upgrade path. Indicates which minor version upgrade is currently in progress.
                        totalSteps:
                          type: integer
                          description: Total number of control plane upgrade steps required to reach the target version.
                        target:
                          type: string
                          description: Target version of the current control plane upgrade step (e.g., "1.33"). Present only while an upgrade step is active.
                        updateId:
                          type: string
                          description: Active AWS EKS update ID for the control plane operation. Used for crash recovery to resume monitoring a previously initiated update.
                        startedAt:
                          type: string
                          format: date-time
                          description: Timestamp when the current upgrade step was initiated. Used for timeout enforcement.
                        completedAt:
                          type: string
                          format: date-time
                          description: Timestamp when all control plane upgrade steps completed.
                    addons:
                      type: array
                      description: Status of each EKS add-on upgrade.
                      items:
                        type: object
                        description: Status of an individual add-on upgrade.
                        properties:
                          name:
                            type: string
                            description: Name of the EKS add-on (e.g., "vpc-cni", "coredns", "kube-proxy").
                          currentVersion:
                            type: string
                            description: Current installed version of the add-on before upgrade.
                          targetVersion:
                            type: string
                            description: Target version the add-on will be upgraded to.
                          status:
                            type: string
                            description: "Upgrade status of this add-on: Pending, InProgress, Completed, Failed, or Skipped."
                          startedAt:
                            type: string
                            format: date-time
                            description: Timestamp when this add-on upgrade was initiated.
                          completedAt:
                            type: string
                            format: date-time
                            description: Timestamp when this add-on upgrade completed.
                    nodegroups:
                      type: array
                      description: Status of each managed node group upgrade.
                      items:
                        type: object
                        description: Status of an individual managed node group upgrade.
                        properties:
                          name:
                            type: string
                            description: Name of the managed node group.
                          currentVersion:
                            type: string
                            description: Current Kubernetes version of the node group AMI before upgrade.
                          targetVersion:
                            type: string
                            description: Target Kubernetes version the node group will be upgraded to.
                          status:
                            type: string
                            description: "Upgrade status of this node group: Pending, InProgress, Completed, Failed, or Skipped."
                          updateId:
                            type: string
                            description: Active AWS EKS update ID for this node group operation. Used for crash recovery.
                          startedAt:
                            type: string
                            format: date-time
                            description: Timestamp when this node group upgrade was initiated. Used for timeout enforcement.
                          completedAt:
                            type: string
                            format: date-time
                            description: Timestamp when this node group upgrade completed.
                conditions:
                  type: array
                  description: Standard Kubernetes conditions representing the current state of the upgrade.
                  items:
                    type: object
                    description: A condition on the EKSUpgrade resource.
                    properties:
                      type:
                        type: string
                        description: Type of the condition (e.g., "AWSAuthenticated").
                      status:
                        type: string
                        description: "Status of the condition: \"True\", \"False\", or \"Unknown\"."
                      reason:
                        type: string
                        description: Machine-readable reason for the condition's last transition (e.g., "AssumeRoleSuccess", "IdentityVerified").
                      message:
                        type: string
                        description: Human-readable message with details about the condition.
                      lastTransitionTime:
                        type: string
                        format: date-time
                        description: Last time the condition transitioned from one status to another.
                startedAt:
                  type: string
                  format: date-time
                  description: Timestamp when the upgrade process started.
                completedAt:
                  type: string
                  format: date-time
                  description: Timestamp when the upgrade completed (Completed or Failed).
                observedGeneration:
                  type: integer
                  description: Last observed generation of the EKSUpgrade spec. Used for leader election and change detection.
                message:
                  type: string
                  description: Human-readable message providing additional details about the current phase or error information if the upgrade failed.
                identity:
                  type: object
                  description: AWS caller identity resolved via STS GetCallerIdentity. Shows which IAM principal the operator is using for API calls.
                  properties:
                    accountId:
                      type: string
                      description: AWS account ID of the caller.
                    arn:
                      type: string
                      description: IAM ARN of the caller (e.g., the assumed role ARN or pod identity ARN).
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: CLUSTER
          type: string
          jsonPath: .spec.clusterName
        - name: TARGET
          type: string
          jsonPath: .spec.targetVersion
        - name: PHASE
          type: string
          jsonPath: .status.phase
        - name: AUTH
          type: string
          jsonPath: .status.conditions[?(@.type=="AWSAuthenticated")].reason
        - name: AGE
          type: date
          jsonPath: .metadata.creationTimestamp
{{- end }}
